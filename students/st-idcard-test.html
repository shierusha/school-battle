<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜創角系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ==============================
   全域背景 / 字體
============================== */
body {
  background: url('https://shierusha.github.io/create-student/imgs/citybg.png') center center no-repeat;
  background-size: cover;
  min-height: 100vh;
  font-family: 'Noto Sans TC', sans-serif;
  overflow: hidden;
}
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.3);
  z-index: 0;
  pointer-events: none;
}
body.dark-bg::before {
  background: rgba(0,0,0,0.3);
}

/* ==============================
   16:9 容器
============================== */
.container-16-9 {
  position: relative;
  max-width: 90%;
  max-height: 90vh;
  aspect-ratio: 16/9;
  overflow: hidden;
  border-radius: 16px;
  box-shadow: 0 0 24px #0004;
  margin: 5vh auto;
}
.bg-img {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  z-index: 1;
}

/* ==============================
   Modal（旋轉 / 背包）
============================== */


.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: modal-fadein-bg 0.25s;
}
@keyframes modal-fadein-bg {
  from { background: rgba(0,0,0,0);}
  to   { background: rgba(0,0,0,0.45);}
}

.modal-content {

  background: rgb(13 27 77 / 82%);      /* 深藍色 + 70%透明 */
  border-radius: 18px;
  border: 2px solid #1eb5e5;              /* 藍色外框 */
  box-shadow: 0 0 16px 2px #62f1fe88,     /* 外發光 */
              0 8px 32px #1eb5e5aa;       /* 藍色下陰影 */
  width: 500px;
  max-width: 93vw;
  height: 340px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: modal-pop 0.32s cubic-bezier(.42,1.4,.51,1.01);
}
@keyframes modal-pop {
  from { opacity: 0; transform: scale(0.92);}
  to   { opacity: 1; transform: scale(1);}
}

.modal-header {
  background: none;
  padding: 15px 20px 0px 24px;
  color: #fff;
  font-size: 1.5em;
  font-weight: bold;
  letter-spacing: 1px;
  text-shadow: 0 1px 4px #000a;
}

.modal-header::after {
content: "";
display: block;
height: 5px;
width: 70%;
margin: 0.5rem 0 0 0;
border-radius: 2px;
background: linear-gradient(
to right,
 #53e2ff99 65%,
#53e2ff00 100%
);
pointer-events: none;

}


.modal-body {
  color: #fff;
  padding: 12px 24px 24px 24px;
  font-size: 1.2em;
  line-height: 1.5;
  text-shadow: 0 1px 4px #0008;
  overflow-y: auto;
  word-break: break-all;  /* or break-word; 都可以 */
  max-height: 240px;      /* 依照 modal 高度調整 */
  white-space: pre-line;
  overflow: auto;
  scrollbar-width: none;          /* Firefox */
  -ms-overflow-style: none;       /* IE & Edge */
}

.modal-body::-webkit-scrollbar {
  display: none;                  /* Chrome & Safari */
}





 /*翻轉按鈕 */
 .row-flip-btn {
  display: flex;
width: 80%; 
height: 80%;
}


.flip-btn {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  background: rgba(250,250,250,0.8); 
  color: #495079;
  border: none;
  border-radius: 12px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 2px 8px #0002;
  transition: background 0.18s, transform 0.13s;
  position: relative;
  outline: none;
  align-items: center;
  justify-content: center; /* 讓內文居中 */

}

.flip-btn:hover {
  background: #fdffb8; 
  transform: translateY(-2px) scale(1.04);
}

/* 箭頭樣式 */
.flip-btn .arrow {
  display: inline-block;
  width: 0.35em;
  height: 0.4em;
  margin-left: 0.12em;
  margin-top: 0.1em;
border-right: 0.22em solid #495079;
border-bottom: 0.22em solid #495079;
  transform: rotate(-45deg);
  vertical-align: middle;
  content: "";
}

/* ==============================
   抽卡按鈕（初始置中 → 抽卡後移到底部）
============================== */
.gacha-buttons {
  position: absolute;
  bottom: 45%; /* 初始居中 */
  left: 50%; transform: translateX(-50%);
  display: flex; gap: 10%;
  width: 60%; height: 11%;
  z-index: 10;
  transition: bottom 0.4s ease;
}
.gacha-buttons.bottom { bottom: 16%; } /* 抽卡後固定下方 */
.gacha-btn {
  flex: 1; height: 100%;
  border-radius: 12px;
  background: rgb(13 27 77 / 82%);
  border: 2px solid #1eb5e5; color: #fff; font-weight: bold;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 12px #53e2ff88, 0 0 24px #1eb5e577 inset;
}
.gacha-btn:hover {
  background: #1eb5e5cc;
  box-shadow: 0 0 18px #53e2ffdd, 0 0 36px #1eb5e5aa inset;
}

/* ==============================
   抽卡結果（十連 / 單抽共用容器）
============================== */
.gacha-results {
  position: absolute;
  top: 12%; left: 50%; transform: translateX(-50%);
  display: flex; flex-direction: column;
  gap: 16px; width: 80%; height: 55%;
  z-index: 9;
}

/* 十連抽：兩行五顆 */
.gacha-row {
  display: flex; justify-content: space-between;
  width: 100%; gap: 12px;
}

/* 抽卡球（圓形 + 內部不可見方框承載文字） */
.gacha-orb {
  position: relative; flex: 1;
  aspect-ratio: 1/1; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; cursor: pointer; user-select: none;
  transition: all 0.3s ease;
}
.orb-inner {
  width: 90%; height: 65%;
  display: flex; align-items: center; justify-content: center;
  text-align: center; line-height: 1.2; font-weight: bold;
}

/* 球初始顏色（未翻開） */
.orb-normal  { background: #fff;    border: 3px solid #ccc; }
.orb-hidden  { background: #c0c0c0; border: 3px solid #aaa; }
.orb-limited { background: gold;    border: 3px solid orange; }

/* 翻開後 → 空心圓框 + 對應顏色文字 */
.gacha-orb.revealed { background: transparent; }
.orb-normal.revealed  { border: 3px solid #fff;    color: #fff; }
.orb-hidden.revealed  { border: 3px solid #c0c0c0; color: #c0c0c0; }
.orb-limited.revealed { border: 3px solid gold;    color: #ffd700; }

/* 單抽模式容器：置中 */
.gacha-results.single {
  display: flex;
  align-items: center;
  justify-content: center;
}

/* 大球：佔滿容器高度（保持正圓） */
.gacha-orb.big {
  aspect-ratio: 1/1;   /* 保持正圓 */
  max-width: 25%;      /* 不要超過寬度 */
}


/* ==============================
   HUD（右下角）
============================== */
.gacha-hud {
  position: absolute;
  bottom: 7%;
  right: 4%;
  display: flex;
  align-items: center;
  gap: 1rem;
  z-index: 30;
  color: #fff;
  text-shadow: 0 1px 4px #000a;
  height: 10%;    
}

/* 累積抽數：不可見框讓 JS 依高度算字體 */
.counter-box {
  height: 100%;
  display: flex;
  align-items: center;
  font-weight: bold;
  padding: 0 6px;
  border-radius: 4px;
  background: rgba(255,255,255,0.01); /* 1% 透明，確保有尺寸 */
}
.gacha-counter {
position: absolute;
  bottom: 7%;
  right: 20%;
  gap: 1rem;
  z-index: 30;
  color: #fff;
  text-shadow: 0 1px 4px #000a;
  height: 10%;    
}

.gacha-results { z-index: 10; }


/* 背包按鈕 + 不可見框 */
.gacha-backpack {
  height: 100%; aspect-ratio: 2.5/1;
  border: 2px solid #1eb5e5; border-radius: 8px;
  background: rgb(13 27 77 / 82%); color: #fff;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 0 8px #53e2ff88, 0 0 16px #1eb5e577 inset;
  display: flex; align-items: center; justify-content: center;
}
.backpack-box {
  height: 100%; display: flex; align-items: center; justify-content: center;
}

/* 背包 modal 的列表字體與數字顏色（JS 亦會縮放） */
.backpack-section { margin: 0.5rem 0; }
.backpack-section h3 { color: #53e2ff; margin-bottom: 0.3rem; }
.backpack-items { color: #fff; }
.backpack-items span { color: #ffe082; font-weight: bold; }

</style>
</head>
<body class="dark-bg">
<!-- 16:9 主要容器 -->
<div class="container-16-9">
  <!-- 抽卡結果容器（單抽/十連共用） -->
  <div class="gacha-results" id="gacha-results"></div>

  <!-- 抽卡按鈕（初始置中，抽卡後會滑到下方） -->
  <div class="gacha-buttons">
    <button id="btn-single" class="gacha-btn">單抽</button>
    <button id="btn-ten" class="gacha-btn">十連抽</button>
  </div>


  <!--  HUD 要在這層 -->
  <div class="gacha-hud">
    <button id="btn-backpack" class="gacha-backpack">
      <div class="backpack-box">背包</div>
    </button>
  </div>
  
    <div class="gacha-counter">
      <div class="counter-box">累積抽數：
        <span id="draw-count">0</span>
      </div>
    </div>
  <!-- 背景圖 -->
  <img class="bg-img" src="https://shierusha.github.io/school-battle/teachers/img/8.webp" alt="background">
</div>

<!-- 旋轉提示（不可關閉） -->
<div id="orientation-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">請旋轉螢幕</div>
    <div class="modal-body">為了最佳體驗，請將裝置轉成橫向模式。</div>
  </div>
</div>

<!-- 背包 Modal（可隨意點背景關閉） -->
<div id="info-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header" id="info-modal-title">標題</div>
    <div class="modal-body" id="info-modal-body"></div>
  </div>
</div>

<script>
  /* ==============================
   旋轉提示（不能關）
============================== */
function checkOrientation() {
  const modal = document.getElementById("orientation-modal");
  if (window.matchMedia("(orientation: portrait)").matches) {
    modal.style.display = "flex";
  } else {
    modal.style.display = "none";
  }
}
checkOrientation();
window.addEventListener("orientationchange", checkOrientation);
window.addEventListener("resize", checkOrientation);
// 阻止點擊關閉（安全）
document.getElementById("orientation-modal").addEventListener("click", e => e.stopPropagation());

/* ==============================
   模擬登入玩家（UI 測試用）
============================== */
const user = { username: "小西", id: "demo-player" };

/* ==============================
   統一文字自適應（所有文字都走這裡）
============================== */
function resizeAllTexts() {
  // 抽卡按鈕字
  document.querySelectorAll('.gacha-btn').forEach(btn => {
    btn.style.fontSize = (btn.offsetHeight * 0.40) + "px";
  });
  // 球內文字
  document.querySelectorAll('.orb-inner').forEach(inner => {
    inner.style.fontSize = (inner.offsetHeight * 0.35) + "px";
  });
  // HUD：累積抽數
  document.querySelectorAll('.counter-box').forEach(box => {
    box.style.fontSize = (box.offsetHeight * 0.50) + "px";
  });
  // HUD：背包按鈕字
  document.querySelectorAll('.backpack-box').forEach(box => {
    box.style.fontSize = (box.offsetHeight * 0.50) + "px";
  });
  // 背包 modal：數字（span）
  document.querySelectorAll('.backpack-items span').forEach(span => {
    const h = (span.offsetHeight || 20);
    span.style.fontSize = (h * 0.80) + "px";
  });
}
resizeAllTexts();
window.addEventListener("resize", resizeAllTexts);

/* ==============================
   DOM 快取
============================== */
const gachaBtns = document.querySelector(".gacha-buttons");
const btnSingle = document.getElementById("btn-single");
const btnTen = document.getElementById("btn-ten");
const resultsContainer = document.getElementById("gacha-results");
const infoModal = document.getElementById("info-modal");
const infoTitle = document.getElementById("info-modal-title");
const infoBody = document.getElementById("info-modal-body");

/* ==============================
   控制：必須翻完才能再抽
============================== */
let canDraw = true;
function checkAllRevealed() {
  const orbs = resultsContainer.querySelectorAll(".gacha-orb");
  const allRevealed = [...orbs].every(o => o.classList.contains("revealed"));
  if (allRevealed) canDraw = true;
}

/* ==============================
   建立一顆球（共用）
   res = { rarity: 'normal'|'hidden'|'limited', name: '角色名' }
============================== */
function createOrb(res, options = {}) {
  const { autoReveal = false, revealDelay = 0, big = false } = options;

  const orb = document.createElement("div");
  orb.classList.add("gacha-orb", `orb-${res.rarity}`);
  if (big) orb.classList.add("big");

  const inner = document.createElement("div");
  inner.classList.add("orb-inner");
  // 初始不放字（不用 ?），外觀用顏色區分
  inner.textContent = "";

  if (autoReveal) {
    // 白球自動依序翻開
    setTimeout(() => {
      inner.textContent = res.name;
      orb.classList.add("revealed");
      // ⚠️ 這裡可觸發 DB 更新（若白球也要記帳）
      // upsertOwnedCharacters(...)
      resizeAllTexts();
      checkAllRevealed();
    }, revealDelay);
  } else {
    // 銀/金：點擊翻開
    orb.addEventListener("click", () => {
      if (!orb.classList.contains("revealed")) {
        inner.textContent = res.name;
        orb.classList.add("revealed");
        // ⚡ 翻開同時做 DB UPDATE（之後接 Supabase）
        // upsertOwnedCharacters(player_id, rarity, event_name, character_id, +1)
        console.log(`update DB: ${res.rarity} - ${res.name}`);
        resizeAllTexts();
        checkAllRevealed();
      }
    });
  }

  orb.appendChild(inner);
  return orb;
}

/* ==============================
   十連抽：兩行五顆
============================== */
function showResultsTen(results) {
  canDraw = false;                       // 鎖住再抽
  resultsContainer.classList.remove("single");
  resultsContainer.innerHTML = "";       // 清空舊結果

  for (let row = 0; row < 2; row++) {
    const rowDiv = document.createElement("div");
    rowDiv.classList.add("gacha-row");

    results.slice(row * 5, row * 5 + 5).forEach((res, idx) => {
      const isWhite = res.rarity === "normal";
      const index = row * 5 + idx;
      const orb = createOrb(res, {
        autoReveal: isWhite,             // 白球自動翻
        revealDelay: index * 200         // 每顆間隔 0.2s
      });
      rowDiv.appendChild(orb);
    });

    resultsContainer.appendChild(rowDiv);
  }
  resizeAllTexts();
}

/* ==============================
   單抽：一顆大球
============================== */
function showResultSingle(res) {
  canDraw = false;                       // 鎖住再抽
  resultsContainer.innerHTML = "";       // 清空
  resultsContainer.classList.add("single");

  // 白球：自動翻；銀/金：點擊翻
  const isWhite = res.rarity === "normal";
  const orb = createOrb(res, {
    autoReveal: isWhite,
    revealDelay: 0,
    big: true
  });

  // 單抽只要這一顆
  const rowDiv = document.createElement("div");
  rowDiv.classList.add("gacha-row");
  rowDiv.style.justifyContent = "center"; // 置中該顆
  rowDiv.appendChild(orb);
  resultsContainer.appendChild(rowDiv);

  resizeAllTexts();

  // 單抽若是白球，翻開即解鎖；若是銀/金，等點擊翻開
  if (isWhite) {
    setTimeout(() => { canDraw = true; }, 10);
  } else {
    // 點擊翻開後，createOrb 的事件裡會呼叫 checkAllRevealed → 解鎖
    // 這裡不做事
  }
}

/* ==============================
   假資料（UI 測試用）
============================== */
const testNames = ["佐佐莉","喵歡","小西","娜娜","瑰","夏娃","波","魅"];
const rarities = ["normal","hidden","limited"];

/* ==============================
   綁定按鈕事件
============================== */
btnTen.addEventListener("click", () => {
  if (!canDraw) { alert("請先翻開所有扭蛋！"); return; }
  gachaBtns.classList.add("bottom"); // 第一次抽就移到底下

  // 十連假資料（之後可換成 DB 計算過的結果）
  const results = Array.from({ length: 10 }, () => ({
    rarity: rarities[Math.floor(Math.random() * rarities.length)],
    name: testNames[Math.floor(Math.random() * testNames.length)]
  }));

  showResultsTen(results);
});

btnSingle.addEventListener("click", () => {
  if (!canDraw) { alert("請先翻開扭蛋！"); return; }
  gachaBtns.classList.add("bottom");

  // 單抽假資料
  const res = {
    rarity: rarities[Math.floor(Math.random() * rarities.length)],
    name: testNames[Math.floor(Math.random() * testNames.length)]
  };
  showResultSingle(res);
});

/* ==============================
   背包（UI 假資料）
============================== */
document.getElementById('btn-backpack').addEventListener('click', () => {
  infoTitle.textContent = `${user.username} 的包包`;

  const items = {
    limited: ["禮服佐佐莉 × <span>1</span>", "禮服貓貓 × <span>1</span>", "禮服齊希 × <span>10</span>"],
    hidden:  ["哈厄斯笑臉 × <span>2</span>", "惡夢 × <span>1</span>"],
    normal:  ["佐佐莉 × <span>10</span>", "娜娜 × <span>20</span>", "小西 × <span>2</span>"]
  };

  let html = "";
  if (items.limited.length) html += `<div class="backpack-section"><h3>活動饅頭：</h3><div class="backpack-items">${items.limited.join("、 ")}</div></div>`;
  if (items.hidden.length)  html += `<div class="backpack-section"><h3>隱藏饅頭：</h3><div class="backpack-items">${items.hidden .join("、 ")}</div></div>`;
  if (items.normal.length)  html += `<div class="backpack-section"><h3>普通饅頭：</h3><div class="backpack-items">${items.normal .join("、 ")}</div></div>`;

  infoBody.innerHTML = html;
  infoModal.style.display = "flex";
  resizeAllTexts(); // 背包打開後也縮放字體
});
// 背包點背景即可關閉；點內容不關閉
infoModal.addEventListener("click", () => infoModal.style.display = "none");
infoModal.querySelector(".modal-content").addEventListener("click", e => e.stopPropagation());

/* ==============================
   抽完全部自動解鎖（安全保險）
============================== */
function monitorUnlock() {
  const orbs = resultsContainer.querySelectorAll(".gacha-orb");
  if (orbs.length === 0) return;
  const allRevealed = [...orbs].every(o => o.classList.contains("revealed"));
  if (allRevealed) canDraw = true;
}
const unlockObserver = new MutationObserver(() => {
  resizeAllTexts();
  monitorUnlock();
});
unlockObserver.observe(resultsContainer, { childList: true, subtree: true });

</script>



</body></html>

