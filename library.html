<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è§’è‰²æ•…äº‹é›†ï½œåœ–æ›¸é¤¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: #f4f7fa; margin: 0; padding: 2rem;}
    .main { max-width: 600px; margin: 2em auto; background: #fff; border-radius: 1.2em; box-shadow: 0 2px 16px #0001; padding: 2em;}
    h2 { color: #1767a0; }
    .btn { background: #1767a0; color: #fff; border: none; border-radius: .5em; padding: .5em 1.2em; margin: 1em 0;}
    .book-list { margin-top: 2em; }
    .book-item { padding: .9em 0; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <div class="main" id="main"><div>è¼‰å…¥ä¸­â€¦</div></div>
<script>
const client = window.supabase.createClient(
  'https://wfhwhvodgikpducrhgda.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
);

(async function() {
  const main = document.getElementById('main');
  // å–å¾—ç›®å‰ç™»å…¥è€…
  const { data: { user } } = await client.auth.getUser();
  if (!user) {
    main.innerHTML = "<div>è«‹å…ˆç™»å…¥å¸³è™Ÿ</div>";
    return;
  }

  // å–å¾— URL åƒæ•¸
  const params = new URLSearchParams(window.location.search);
  const student_id = params.get('student_id');
  const student_name = params.get('student_name');

  if(!student_id){
    main.innerHTML = "<div>ç¼ºå°‘è§’è‰²è³‡è¨Šï¼è«‹å¾å­¸ç”Ÿè­‰é é€²å…¥ã€‚</div>";
    return;
  }

  // æŸ¥è§’è‰²è³‡è¨Š
  let { data: student } = await client
    .from('students')
    .select('player_id, name')
    .eq('student_id', student_id)
    .single();

  // æŸ¥è§’è‰²çš„æ‰€æœ‰æ›¸æœ¬
  let { data: books } = await client
    .from('books')
    .select('id, title, updated_at')
    .eq('student_id', student_id)
    .order('updated_at', { ascending: false });

  // æ¬Šé™åˆ¤æ–·
  let canEdit = (student && student.player_id === user.id);

  // æ¨™é¡Œï¼‹åŠŸèƒ½
  main.innerHTML = `
    <h2>ã€${student_name || student?.name || "æœªçŸ¥è§’è‰²"}ã€‘çš„æ•…äº‹é›†</h2>
    <div style="color:#888;">${canEdit ? "ä½ å¯ä»¥ç‚ºæ­¤è§’è‰²å‰µä½œæ–°æ›¸" : "ä½ åªèƒ½é–±è®€ï¼Œç„¡æ³•å‰µå»ºæ–°æ›¸"}</div>
    ${canEdit ? '<button class="btn" id="btnNewBook">ï¼‹ æ–°å¢æ›¸ç±</button>' : ''}
    <div class="book-list">${books && books.length ? books.map(b=>`
      <div class="book-item">ğŸ“— <b>${b.title}</b> <span style="color:#aaa;font-size:.95em;">(${b.updated_at?.slice(0,10)||""})</span></div>
    `).join('') : '<div style="color:#aaa;">ç›®å‰æ²’æœ‰æ›¸ç±ã€‚</div>'}</div>
  `;

  // å‰µæ›¸åŠŸèƒ½ï¼ˆä½ å¯ä»¥æ”¹æˆé–‹å°è©±æ¡† or è·³ç·¨è¼¯å™¨é ï¼‰
  if(canEdit){
    document.getElementById('btnNewBook').onclick = async ()=>{
      const title = prompt("è«‹è¼¸å…¥æ›¸åï¼š", "æˆ‘çš„æ•…äº‹æ›¸");
      if(!title) return;
      let { error } = await client.from('books').insert([{
        owner_id: user.id,
        student_id,
        title,
      }]);
      if(error) return alert('æ–°å¢å¤±æ•—: ' + error.message);
      location.reload();
    }
  }
})();
</script>
</body>
</html>
